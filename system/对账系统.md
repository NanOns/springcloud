### 对账系统

#### 基本概念扫盲
* 对账
````text
信息流对账: 内部系统,支付系统的支付数据与业务数据进行对账，保证支付交易与业务交易一致性
资金流对账: 支付系统与银行或第三方支付系统进行对账

对账方式
单向对账：一般拿第三方支付机构或银行流水，与自己系统进行对账，防止出现掉单问题；
双向对账：两个应用间的流水进行双向核对，如订单与财务系统，既要保证财务系统支付成功的记录，
订单系统也是成功的；也要确保订单系统记录成功的记录，财务系统也成功。
````
* 对账相关的问题
```text
不同系统日切点不一致问题：滚动对账
差错处理：补账，补偿（退款）
```

* 轧帐和平帐
```text
每一笔交易，都要做到各参与者的记录能够吻合，没有偏差。对账系统的工作，是发现有差异的记录，即轧帐；
然后通过人工或者自动的方式，解决这些差异，即平帐。
```

* 长款和漏单
```text
长款: 以平台交易为基准与银行交易，发现周期内交易，平台有此订单银行没有.(跨天生成交易数据)
短款: 以银行交易为基础与业务进行对账， 银行有平台没有，则称漏单

```

* 清算和结算
```text
清算：计算各方应收应付钱款的时间与金额。
结算：根据清算的结果在指定的时间对各方进行实际的资金转移操作
```

* 对账算法
```text
一、流程：

1、从上游渠道（银行、银联等金融机构）获取对账文件，程序逐行解析入库；
2、在程序处理中，以上游对账文件的表为基准，程序逐行读取并与我们系统的交易记录对比账务记录（有账务系统情况下，合理方案应该是于账务记录）对比，查找出差异记录；
3、以我们系统的交易记录对比账务记录为基准，程序逐行读取与上游对账文件对比，查找出差异记录。

二、缺陷：

1、对账过程中查询相关数据，如果数据量巨大，对数据库性能影响较大，而且对账逻辑扩展极为麻烦；
2、逐行比对算法效率较低，但算法上并无好的优化余地。如果采用数据库INTERSECT、MINUS对数据库压力也高； 
3、在业务量大的情况下（例如有上百家上游渠道需要对，每一家都有几十万条交易记录），对账服务器及数据库服务器负荷较高。即便采用读写分离，对账时候使用读库，压力一样很大；
4、导入批量文件，逐行入库效率较为低下（每一次都需要建立网络连接、关闭连接）。
```

![输入图片说明](https://github.com/qccr-twl2123/springcloud/blob/master/images/duizhang.png "在这里输入图片标题")


* 对账处理
```text
对账文件中包含的主要信息有：
商户订单号、交易流水号、交易时间、支付时间、付款方、交易金额、交易类型、交易状态这些字段。
```


* 参考
```text
http://www.ityouknow.com/pay/2017/06/13/reconciliation-system.html
```